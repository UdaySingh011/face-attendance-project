<!DOCTYPE html>
<html>
<head>
  <title>Face Attendance System</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.4.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>

<h1>Face Attendance System</h1>

<button id="startBtn">Start Recognition</button>
<p id="status"></p>

<div id="webcam-container"></div>

<script>
  const URL = "./model/";
  let model, webcam, maxPredictions;

  const startBtn = document.getElementById('startBtn');
  const statusP = document.getElementById('status');
  const webcamContainer = document.getElementById('webcam-container');

  async function init() {
    statusP.innerText = "Loading model...";
    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
    maxPredictions = model.getTotalClasses();

    statusP.innerText = "Initializing webcam...";
    webcam = new tmImage.Webcam(400, 300, true);
    await webcam.setup();
    await webcam.play();
    webcamContainer.appendChild(webcam.canvas);

    statusP.innerText = "Ready! Click Start Recognition again to start detection.";
  }

  async function predict() {
    webcam.update();
    const prediction = await model.predict(webcam.canvas);
    
    let highestProb = 0;
    let predictedClass = "";

    for (let i = 0; i < maxPredictions; i++) {
      if (prediction[i].probability > highestProb) {
        highestProb = prediction[i].probability;
        predictedClass = prediction[i].className;
      }
    }

    if (highestProb > 0.85) {
      statusP.innerText = `Detected: ${predictedClass} (${(highestProb * 100).toFixed(2)}%)`;

      // Send attendance data to Google Sheet (replace YOUR_WEB_APP_URL with your deployed URL)
      fetch('https://script.google.com/macros/s/AKfycbz-1RtsB0tOfQthlktSe3FhzGQN7ua_f_6pClhgPu8B2ZdKY1zdGDzHNasMTdcMWbOX/exec', {
        method: 'POST',
        body: JSON.stringify({ name: predictedClass }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.text())
      .then(text => console.log('Sheet response:', text))
      .catch(error => console.error('Error sending data:', error));
    } else {
      statusP.innerText = "No confident detection yet.";
    }
  }

  let isPredicting = false;
  let predictLoop;

  startBtn.addEventListener('click', async () => {
    if (!model) {
      await init();
      startBtn.innerText = "Start Recognition";
    } else if (!isPredicting) {
      isPredicting = true;
      predictLoop = setInterval(predict, 1000);
      startBtn.innerText = "Stop Recognition";
    } else {
      clearInterval(predictLoop);
      isPredicting = false;
      startBtn.innerText = "Start Recognition";
      statusP.innerText = "Recognition stopped.";
    }
  });
</script>

</body>
</html>
